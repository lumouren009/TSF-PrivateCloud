# TSF 产品使用手册

[TOC]

</br>


## 产品简介
### 概述
腾讯分布式服务框架 （Tencent Service Framework） 是一个围绕着应用和微服务的 PaaS 平台，提供应用全生命周期管理、数据化运营和立体化监控等功能。TSF 拥抱 Spring Cloud 微服务框架，帮助企业客户解决传统集中式架构转型的困难，打造大规模高可用的分布式系统架构，实现业务、产品的快速落地。

TSF 以腾讯云中间件团队多款成熟的分布式产品为核心基础组件，提供秒级推送的分布式配置服务、链路追踪等高可用稳定性组件。此外，TSF 与腾讯云 API 网关打通，让企业轻松构建大型分布式系统。

### 产品功能
#### 服务注册发现
TSF 服务注册发现包括三个角色，服务提供者，服务调用者和服务注册中心。服务提供者和服务调用者将地址信息注册到服务注册中心，并从服务注册中心获取所有注册服务的实例列表。TSF 使用 Consul 作为服务注册中心。服务提供者和消费者使用 Spring Cloud Consul 组件来实现与 Consul 服务注册中心集群的通信。

#### 应用生命周期管理
TSF 提供从创建应用到运行应用的全程管理，功能包括创建、删除、部署、回滚、扩容、下线、启动和停止应用。TSF 提供应用分组来实现应用的版本控制和灰度发布功能。同时，在 TSF 控制台上可以设置自定义 JVM 参数。TSF 将每次操作记录下来，用户可以在应用的变更记录页面中查看和搜索变更记录。

#### 数据化运营
TSF 提供全面的监控和分布式调用链分析工具，帮助用户把握应用上线后的运行状况。</br>

* 监控包括 IaaS 基础监控和应用监控。IaaS 基础监控的指标包括实例 CPU、内存、网络和磁盘等，应用监控的指标包括应用的QPS, 请求时间和请求出错率等。
* 分布式调用链分析包括调用链查询和调用链详情。用户可以根据时间范围和服务名等条件来查询一组调用链。调用链详情显示了请求经过每个服务的层次关系和耗时情况等信息。

### 名词解释
#### 资源管理

| 专有名词 | 对应英文 | 解释 | 
|--------|---------|---------|
| 集群 | Cluster | 集群是指云资源管理的集合，包含了运行应用的云主机等资源。集群中的云资源可以是容器、可以是虚拟机等。在同一个集群中，资源之间可以互相通信。 |
| 命名空间 | Namespace | 命名空间是对一组资源和对象的抽象集合。命名空间起到的作用是将同一个集群下的资源进行隔离，使用相同的账号创建不同的环境。在同一个集群中可以有多个命名空间。集群中的资源只能属于一个命名空间。在使用中，用户可以将一个集群隔离为开发环境、测试环境等等。
| 部署组 | Deployment Group | 部署组是执行应用批量部署的逻辑概念。一个部署组内包括多个实例，每个实例上运行相同的应用程序。同一个部署组上可以运行一个或者多个应用，但其中的每个实例应用相同。 |

#### 应用生命周期管理相关名词

| 专有名词 | 对应英文 | 解释 | 
|---------|---------|---------|
|应用| Application | 应用是可部署的软件实体，包含一个或一组容器或进程。|
| TSF Agent | TSF Agent | TSF Agent 是 TSF 中部署在应用机器上的 Daemon 程序，在运行中承担接收和执行扩容等任务、上报机器运行状态、上报应用监控数据等功能；同时也是 TSF 控制台与应用程序之间通信的桥梁。 | 
| TSF 应用生命周期管理 | TSF Application Lifecycle Management | 应用是 TSF 管理的基本单位，TSF 提供了完整的应用生命周期管理能力，可以完成从部署到运行过程的全程管理，包括应用创建、部署、启动、回滚，扩容缩容和停止下线等操作。| 

#### 服务框架相关名词

| 专有名词 | 对应英文 | 解释 | 
|--------|---------|---------|
| 微服务 | Microservice| 微服务是一些协同工作的小而自治的服务，具有弹性扩展、简化部署、可组合等优点。一个微服务既可以是服务提供者，也可以是服务消费者。| 
| Spring Boot | Spring Boot | Spring Boot 是一种用于简化 Spring 应用的初始搭建以及开发过程的框架，该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板式的配置。 | 
| Spring Cloud | Spring Cloud | Spring Cloud 是一系列框架的集合，利用 Spring Boot 开发简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以用 Spring Boot 的开发风格做到一键启动和部署。| 


#### 数据化运营与监控相关名词

| 专有名词 | 对应英文 | 解释 | 
|---------|---------|---------|
|TSF 分布式跟踪系统| TSF Distributed Tracing System| TSF 调用链跟踪能够分析每一次请求的调用路径，帮助用户了解调用链各阶段耗时情况和状态，从而精准发现系统的瓶颈和隐患。|


#### 分布式工具相关名词
| 专有名词 | 对应英文 | 解释 | 
|---------|---------|---------|
| TSF 分布式配置管理| TSF Distributed Configuration Management | TSF 分布式配置管理实现了将分布式系统的配置信息在 TSF 控制台上进行集中管理，可以实时新增、修改、删除配置，并将更新的配置推送到全局或者应用内部。 |

### 概念关系
#### 集群、命名空间、部署组与实例之间的关系如下：

![](https://main.qcloudimg.com/raw/355952bf6f6d5b68bac1990989257320.jpg)

**集群** 是实例的集合。在同一个集群中，可以存在很多资源，而在实际的工作中，常常需要将这些资源进行隔离。具体可参考 [集群](https://cloud.tencent.com/document/product/649/13684)。

**命名空间** 将集群的环境隔离开，构造彼此独立的环境，如开发环境、测试环境的隔离等等。同一命名空间下存在不同的部署组。具体可参考 [命名空间](https://cloud.tencent.com/document/product/649/15522)。
    
**部署组** 也是实例的集合，范围比集群和命名空间更小。用户通过部署组来部署应用，同一部署组上的实例运行的应用相同。具体可参考 [部署组](https://cloud.tencent.com/document/product/649/16932)。


## 集群

集群是指云资源管理的集合，包含了运行应用的云主机等资源。集群包括虚拟机集群和容器集群两种类型。

集群操作支持创建集群、删除集群、导入节点、移出节点等操作。

### 部署组基本操作
#### 新建集群

1. 登录TSF控制台。
2. 单击左侧导航栏中的 **集群**，单击集群列表页的【新建】。
 ![](https://main.qcloudimg.com/raw/2348e3469caaadb31b72e62853df5dd4.png)
3. 设置集群的基本信息。
 - **集群名称**：集群名称，不超过60个字符。
 - **集群类型**：选择集群类型
     - 虚拟机集群：虚拟机集群中的节点用于部署虚拟机应用。
     - 容器集群：容器集群中的节点用于部署容器应用。
 - **集群描述**：集群的描述，不超过200个字符。
 
![](https://main.qcloudimg.com/raw/9dd15d9f43880d903669fb455bd90bdd.png)

#### 删除集群

1. 在集群列表页中，单击某集群右侧的【删除】。
2. 弹出提示页面，显示集群下的节点信息，单击【确定】删除集群。
![](https://main.qcloudimg.com/raw/76924d98ccccd6898a1d0823f240bd14.png)

>**注意：**
> 集群在删除期间，无法对外提供服务，请提前做好准备，以免造成影响。

#### 虚拟机集群添加已有节点

1. 在集群列表页中，找到希望添加节点的虚拟机集群，单击目标集群 **ID/集群名** 。
2. 点击节点列表上方的 **导入节点** 按钮。
![](https://main.qcloudimg.com/raw/873a907bd4153ddd675844ba1e66a176.png)
3. 选择节点所属的命名空间，如果没有合适的命名空间，则点击“新建命名空间”进行新建。
![](https://main.qcloudimg.com/raw/8b2e001d0112ada570db5d8bc7a36d74.png)
4. 点击“复制”按钮将需要复制的脚本复制到希望添加进入集群的实例上，在实例上运行。这段脚本用户将agent安装到虚拟机上，执行成功之后需要稍等片刻，主机即可显示在节点列表上。

#### 从虚拟机集群移出节点

1. 在集群列表页中点击集群的 **ID/名称**，进入集群的节点列表页面，选择需要移出的云主机，单击右侧 【移出】。
2. 对于已经绑定了资源的云主机，需要点击绑定的应用资源，在应用页面将实例下线，才能进行删除操作。
![](https://main.qcloudimg.com/raw/bd2ff45ca23534418804c1612a1bac3e.png)
3. 对于已经解绑应用的云主机，点击右侧的删除按钮，将脚本复制到对应主机上进行删除，并点击“提交”按钮完成删除。
![](https://main.qcloudimg.com/raw/e86c4d1f9605f2366e86546af04cfac6.png)

#### 容器集群添加已有节点
1. 在tsf控制台上新建容器集群。
2. 在灵雀云控制台上找到对应的集群，点击“添加云主机”按钮，弹出对话框，复制脚本，在需要添加为master的节点上执行这个脚本。
![](https://main.qcloudimg.com/raw/b6aa760e02b94e4f2b0c0c3a75b885a8.png)
3. 执行完步骤2之后，在灵雀云控制台上可以看到添加的节点，部署集群按钮变成可操作，点击部署集群，进行部署。部署过程比较长，耐心等待，部署完成后集群和节点都变成运行中。
![](https://main.qcloudimg.com/raw/5b1ac712d05e6f048df9252f8ad56e9e.png)
4. 参考【创建命名空间】流程，在TSF控制台上创建对应集群的命名空间。

5. 在tsf控制台中集群-对应集群的详情-节点列表-导入节点页面选择命名空间并将脚本复制在实例上运行。完成slave节点的添加。

![](https://main.qcloudimg.com/raw/1ca0f4c39225995fc1c96866c5a95bfe.png)

#### 从容器集群移出节点

1. 在集群列表页中点击集群的 **ID/名称**，进入集群的节点列表页面，选择需要移出的云主机，单击右侧 【移出】。
2. 对于已经绑定了资源的云主机，需要点击绑定的应用资源，在应用页面将实例下线，才能进行删除操作。
![](https://main.qcloudimg.com/raw/bd2ff45ca23534418804c1612a1bac3e.png)
3. 对于已经解绑应用的云主机，点击右侧的删除按钮，将脚本复制到对应主机上进行删除，并点击“提交”按钮完成删除。请注意这个过程可能需要一定时间。 
![](https://main.qcloudimg.com/raw/e86c4d1f9605f2366e86546af04cfac6.png)



## 命名空间

命名空间 ( Namespace ) 是对一组资源和对象的抽象集合。例如可以将开发环境，联调环境，测试环境的服务分别放到不同的命名空间中。

### 命名空间类别

命名空间按创建类型分为两大类：集群默认创建的命名空间的和用户创建的命名空间。

- 默认命名空间：虚拟机集群的默认命名空间是 `default`。
- 用户创建命名空间：用户可以在集群中按照需要创建命名空间。可以按照不同的环境创建对应的 命名空间，例如开发环境，联调环境和测试环境分别创建对应的命名空间。

### 命名空间基础操作

#### 创建命名空间
1. 登录TSF控制台。
2. 单击左侧导航栏中的【命名空间】。
3. 在命名空间列表上方【新建命名空间】按钮。

![](https://main.qcloudimg.com/raw/8347d37d5a3129c3a279b604a97db70f.png)
4. 填写命名空间的名称和描述，并单击【提交】。

![](https://main.qcloudimg.com/raw/ed22b9152f5f4263c098081f8109a31c.png)

#### 配置命名空间code
code是标识命名空间的业务ID，在API网关配置微服务API后，调用API时需要带上code来访问命名空间内的微服务。请注意，每一个命名空间code都不能重复，即使时不同的集群中的命名空间也不能拥有相同的code。
1. 登录TSF 控制台。
2. 单击左侧导航栏中的 【命名空间】 。
3. 单击命名空间列表【配置code】按钮。
![](https://main.qcloudimg.com/raw/49962495baa5643993fb57f3d67b21ae.png)
4. 填写code，并点击提交。

#### 删除命名空间
1. 登录TSF 控制台。
2. 单击左侧导航栏中的 【命名空间】 。
3. 单击命名空间列表【删除】按钮。
![](https://main.qcloudimg.com/raw/8c9df4f7037f9f409f5a947b50fb2a7d.png)
4. 单击【确认】删除命名空间。
![](https://main.qcloudimg.com/raw/7df5d2db9db3a66718f6a8ad81f26dce.png)


>**注意：**
>
>删除命名空间将销毁命名空间下的所有资源，销毁后所有数据将被清除且不可恢复，清除前将请提前备份数据。

>系统命名空间不能删除。

>对于绑定了资源的命名空间，删除需要先到【部署组】页面将资源解绑才能删除。


## 部署组

### 部署组概述

部署组是执行应用批量部署的逻辑概念。一个部署组内包括多个应用实例，每个应用实例上运行相同的应用程序。
部署组的操作包括：创建部署组、删除部署组、部署应用、启动应用、应用扩容等。

### 部署组类型
按照部署组关联的应用类型，部署组分为虚拟机应用部署组和容器应用部署组。参阅 **应用概述** 部分。

**虚拟机应用部署组**：使用虚拟机来部署应用。参阅 **虚拟机应用部署组** 部分。

**容器应用部署组**：使用 Docker 容器来部署应用。Docker 应用部署时，将在虚拟机上创建多个 Docker 容器实例。参阅 **容器应用部署组** 部分。

|类型|虚拟机应用部署组|容器应用部署组|
|---|---|---|
|实例类型|虚拟机|Kubernetes Pod|
|部署方式|JAR 包|镜像|
|操作|部署应用、停止应用、启动应用、下线实例、扩容|部署应用、停止应用、启动应用、扩缩容|

### 
虚拟机部署组的操作包括两种：

- 基本操作：部署组的创建和删除。

### 部署组基础操作

#### 创建部署组
1. 登录 TSF 控制台。
2. 单击左侧导航栏中的 **部署组**。
3. 选择部署组所属集群和所属命名空间。
4. 单击部署组列表上方的【新建部署组】按钮。
![](https://main.qcloudimg.com/raw/32a77065ff7be0c2d2b961210dd91f49.png)
5. 设置部署组相关信息。
 - 部署组名称：部署组的名称，不超过 60 个字符。
 - 描述：部署组的描述，不超过 200 个字符。
 - 日志配置项：关联的日志配置项用于指定部署组的日志的采集路径。
![](https://main.qcloudimg.com/raw/630af481058916dcb8a1460c42596a40.png)
 
#### 删除部署组
1. 单击部署组列表页右侧的【删除】。
2. 弹出提示页面，显示集群下的节点信息，单击【确定】删除集群。
![](https://main.qcloudimg.com/raw/4fab561b595e7f5fe0934c5286d63b37.png)

### 虚拟机应用部署组

虚拟机应用部署组与应用生命周期管理相关的操作包括：添加实例（扩容）、下线实例（缩容）、部署应用、启动应用、停止应用。

#### 应用生命周期管理相关

|功能|说明|
|---|---|
|添加实例 |将虚拟机添加到部署组中，如果部署组此时已经关联了程序包，将执行部署命令。|
|下线实例|停止虚拟机上的应用，然后将实例从部署组中移除。|
|部署应用|将应用部署到虚拟机上，并执行启动命令。|
|启动应用|当应用处于停止状态时可以启动应用。|
|停止应用|当应用处于运行中状态时可以停止应用。|

#### 添加实例

1. 单击部署组列表右侧的【添加实例】。
![](https://main.qcloudimg.com/raw/37fc0a97a0f9cfb604aabbbfa08716ba.png)
2. 选择要添加进部署组的虚拟机，单击【提交】。
![](https://main.qcloudimg.com/raw/faec0361e818ebd5d493380bd9f5a0f3.png)
3. 在部署组的实例列表页面中显示出刚刚添加的虚拟机。
![](https://main.qcloudimg.com/raw/4b3008ff2108c1685c9d829ecf93f7a7.png)

#### 下线实例
1. 单击目标部署组。
![](https://main.qcloudimg.com/raw/ddb085ca8872b32713bfe08110a0425b.png)
2. 单击实例列表右侧的【下线】按钮。
![](https://main.qcloudimg.com/raw/a2e3fc807fee1ccc91a69181b2949135.png)
3. 在弹出的确认页面中，点击【确认】。
![](https://main.qcloudimg.com/raw/2a0231eb532448e01b1e9860ed80fb62.png)

#### 部署应用
1. 单击部署组列表页右侧的【部署应用】。
![](https://main.qcloudimg.com/raw/5913a88a12e8a8095cd470ae656b1388.png)
2. 选择程序包后，单击【提交】按钮。
![](https://main.qcloudimg.com/raw/71a1026c426930c4b141b3f93bb65f6e.png)
3. 应用部署成功后，部署组中的 **已启动/总机器数** 数值发生变化。
![](https://main.qcloudimg.com/raw/98c3e032bd4ba13a2f8f5cd9697b8dcc.png)

#### 启动应用
1. 单击部署组列表页右侧的【启动应用】。
![](https://main.qcloudimg.com/raw/20f4fa7b81fe6e1363c05fdb59672a67.png)
2. 在弹出的确认页面中，单击【确认】。
![](https://main.qcloudimg.com/raw/4048554f86f07a8db2f27c2a6bfebbd5.png)

#### 停止应用
1.单击部署组列表页右侧的【停止应用】。
![](https://main.qcloudimg.com/raw/ffcd4c41750f4d708c805ca231a72a82.png)
2. 在弹出的确认页面中，单击【确认】。
![](https://main.qcloudimg.com/raw/21876588443b90b1e370f3aa295b4bbf.png)


### 容器应用部署组
容器应用部署组与应用生命周期管理相关的操作包括：部署应用、应用扩缩容、启动应用、停止应用等。

#### 部署应用

1. 单击部署组列表页右侧的【部署应用】。
![](https://main.qcloudimg.com/raw/2ba1eaab0d61c6ab084dbf5e7ca01f98.png)
2. 设置部署信息。

 - **网络访问方式**: 网络的访问方式决定了部署组内应用的网络属性，不同访问方式的应用可以提供不同网络能力。参阅 **容器部署组访问方式** 部分。
 
     - **NodePort**: 访问方式不绑定外网负载均衡，在集群内所有主机节点自动分配 NodePort 端口，可通过 **集群内任意主机IP + NodePort** 访问该服务。
     - **集群内访问**：访问方式不绑定外网负载均衡，该服务只能在集群内部访问。
   
 - **选择镜像**：选择要部署的镜像。
 - **资源限制**：Request 用于预分配资源,当集群中的节点没有 Request 所要求的资源数量时,容器会创建失败。Limit 用于设置容器使用资源的最大上限，避免常情况下节点资源消耗过多。
 - **实例数量**：一个实例由相关的一个容器构成，可单击 + 和 - 控制实例数量。
 - **端口映射**：容器端口与服务端口的映射关系。
     - 协议：TCP、UDP。
     - 容器端口：容器内应用程序监听的端口。
     - 服务端口：集群外通过负载均衡域名或IP+服务端口访问服务；集群内通过服务名+服务端口访问服务。建议和容器端口保持一致。
		
![](https://main.qcloudimg.com/raw/7693ec840f19134f826d37041b052813.png)

#### 应用扩缩
1. 单击部署组右侧的【应用扩缩】。
![](https://main.qcloudimg.com/raw/19e389070d75dd3011144d1c67e95b69.png)
2. 选择扩缩的实例数量后，单击【提交】按钮。
![](https://main.qcloudimg.com/raw/4e7a2707b4d72af517fff110e80d62a9.png)

### 容器部署组访问方式

容器部署组的访问方式决定了部署组的网络属性，不同访问方式的部署组可以提供不同网络能力。TSF 提供两种访问方式：仅在集群内访问 和 NodePort 访问。

#### 仅在集群内访问
提供集群内访问的服务将会提供一个可以被集群内其他服务或容器访问的入口（服务 IP），数据库类等服务如 MySQL 可以选择集群内访问，以保证服务网络隔离。
例如创建一个仅在集群内访问的 MySQL 服务，在设置服务访问方式时选择 **仅在集群内访问**。创建完成后的服务可以通过 **服务 IP + 服务端口** 直接访问。

![](https://main.qcloudimg.com/raw/810442c0e6d2522a86e14c2c565b224f.png)

#### NodePort 访问
该访问方式不绑定外网负载均衡，在集群内所有主机节点自动分配 NodePort 端口，可通过 **集群内任意主机IP + NodePort** 访问该服务。用户可以在部署组的详情页中查看 NodePort 信息。


## 应用中心

### 应用概述
TSF 应用分为两种类型：

- **虚拟机应用：**通过 JAR 包部署在虚拟机上的应用。
- **容器应用：**通过镜像部署在 Docker 容器中的应用。

![](https://main.qcloudimg.com/raw/3c98311621ab5160bbd82301eea9d543.png)

虚拟机应用和容器应用的对比如下：

|应用类型|虚拟机应用|容器应用|
|---|---|---|
|应用托管方式| 一台虚拟机部署一个应用 | 使用 Docker 部署应用，一台虚拟机可以部署多个应用|
|使用场景| 传统部署场景 | 对容器运行环境需要定制和希望提升资源利用率的场景|
|集群类型|虚拟机集群|容器集群|
|部署方式|JAR 包|镜像|
|应用举例|Spring Boot、 Dubbo|Spring Boot、 Dubbo、MySQL、WordPress|



### 应用基本操作

应用基本操作包括创建应用、删除应用。

#### 创建应用
1. 登录TSF 控制台。
2. 单击左侧导航栏 **应用管理**。
3. 在应用列表上方单击【新建应用】。
![](https://main.qcloudimg.com/raw/fd2e0338603b1a7c2af90a719a3a1d75.png)
4. 设置应用信息后，单击【提交】按钮。
 - 应用名: 不超过60个字符。
 - 应用类型: 虚拟机应用将部署在虚拟机上，容器应用将部署在容器上。
![](https://main.qcloudimg.com/raw/013ad5f4c8da463d1f6edd7a67261e04.png)

#### 删除应用
1. 在应用列表右侧单击【删除】。
![](https://main.qcloudimg.com/raw/6d35a19840ef8cfee26d8d1375c33294.png)
2. 在确认弹框中单击【确认】按钮。
![](https://main.qcloudimg.com/raw/7f7954e341dd92c9128c97ef7ada0fe5.png)

>**注意：**
>当应用下有资源（部署组等）时，无法执行删除操作，需要先移除资源才能执行删除操作。


### 程序包管理（仅适用于虚拟机应用）

仅虚拟机应用支持程序包管理。程序包管理包括上传程序包、删除程序包。
目前 TSF 仅支持上传 FatJar 格式的程序包，用户可以参考 **如何打一个 FatJar 包** 部分。

#### 上传程序包
1. 登录 TSF 控制台。
2. 单击左侧导航栏 **应用管理**。
3. 单击目标应用的 **ID/应用名**。
4. 单击 **程序包管理** 标签页，单击【上传程序包】按钮。
![](https://main.qcloudimg.com/raw/41bfef19df866bd09ebae4716ce59d2b.png)
5. 在 **上传程序包** 对话框中填写相关参数。

	- 上传方式：选择 上传 fatjar 包
	- 上传程序包：单击【选择文件】，选择编译为 fatjar 格式的程序包
	- 程序包版本：填写版本号
	- 备注：填写备注
![](https://main.qcloudimg.com/raw/9cb8a5903c374e280054507aed8f194f.png)
6. 点击【提交】按钮，程序包上传成功后出现在程序包列表中。


#### 删除程序包

1. 单击程序包列表右侧的【删除】按钮。
![](https://main.qcloudimg.com/raw/c9fb8dc64111c08f6bec0e04dd7b1114.png)
2. 在确认框中单击【确认】按钮。

### 镜像管理（仅适用于容器应用）

仅容器应用支持镜像管理。镜像管理通过命令行来登录镜像仓库、推送本地镜像到镜像仓库等操作。

#### 镜像仓库使用指引

TSF 中镜像仓库和容器应用一一对应。创建容器应用后，在容器应用的详情页中找到【镜像】标签页。单击【使用指引】按钮，镜像仓库的使用指引。

![](https://main.qcloudimg.com/raw/a0653efcf8ee48405731ae02d21e67d3.png)

使用指引中显示了查看登录镜像仓库、拉取镜像和推送镜像到仓库的命令行。

![](https://main.qcloudimg.com/raw/40a42d780ecf04ad3550e9ab683f862f.png)

在执行这些操作前，请确保执行命令的机器上已安装 `docker` ，同时可以访问镜像仓库。
使用 `sudo` 允许系统管理员让普通用户执行 `docker` 命令。

##### 登录镜像仓库

```
sudo docker login --username=<账号ID>  [仓库IP]:[Port]
```

> 如果用户需要输入两次密码，首次为 sudo 密码，第二次为镜像仓库登录密码。

##### 拉取镜像

```
sudo docker pull [NAME]:[tag]
```
其中 `[NAME]`表示镜像名称，`[tag]` 表示镜像标签，例如：

```
sudo docker pull 172.163.1.1:8080/tsf_123456/tsf_demo:v1.0
```

##### 推送镜像到仓库

**1. 登录镜像仓库**

```
sudo docker login --username=<账号ID>  [仓库IP]:[Port]
```

**2. 给镜像打 tag**

```
sudo docker tag [ImageId] [TARGET_IMAGE]:[tag]
```
其中 `[ImageId]` 表示源镜像 ID，可以通过 `docker image ls` 命令查看。`[TARGET_IMAGE]`表示目标镜像名称，直接复制控制台上的名称即可。`[tag]` 表示镜像标签。例如：

```
sudo docker tag 0e5574283393 172.163.1.1:8080/tsf_123456/tsf_demo:v1.0
```


**3. 将镜像推送到仓库**

```
docker push [TARGET_IMAGE]:[tag]
```

其中 `[TARGET_IMAGE]` 和 `[tag]` 和第 2 步保持一致。例如：

```
docker push 172.163.1.1:8080/tsf_123456/tsf_demo:v1.0
```

### 应用配置 

应用配置（分布式配置）功能用于动态更新应用代码中的配置。
应用配置包括管理配置和发布配置两部分。管理配置包括创建配置、生成新版本配置和删除配置。配置可以发布到部署组

#### 创建配置
1. 登录 TSF 控制台。
2. 单击导航栏 **应用管理**。
3. 单击目标应用的 **ID/应用名**。
4. 单击 **应用配置** 标签页。
5. 单击【新建】按钮。
![](https://main.qcloudimg.com/raw/5e065dffacc6664340589f21110daa9d.png)
6. 填写配置内容。配置可以按照 YAML 或者键值对的方式进行编辑。
7. 单击【提交】按钮。
![](https://main.qcloudimg.com/raw/107a20f24e86c28615096e5336aaa5a9.png)

#### 生成新版本配置
1. 单击配置列表右侧的【生成新版本】。 
![](https://main.qcloudimg.com/raw/843506eedfe076be30c2ada78e42aeb4.png)
2. 填写变更的配置内容和版本号。
3. 单击【提交】按钮。
![](https://main.qcloudimg.com/raw/f2482ef9e72ecd2768926baf4765ed5d.png)

>**注意**:
> 新版本配置的版本号不能与原版本相同。

#### 删除配置
1. 单击配置列表右侧的【删除】。
![](https://main.qcloudimg.com/raw/f87b21e276020244ee5e38e40f024562.png)
2. 在弹框中，单击【确认】。

#### 发布配置
1. 单击配置列表右侧的【发布】按钮。
![](https://main.qcloudimg.com/raw/7ba9cec22541ac8480e00860418f7f7c.png)
2. 选择配置发布的目标部署组，填写发布描述。
3. 单击【提交】。
![](https://main.qcloudimg.com/raw/4c3ada40cbfa4cbb376e105b192fc93b.png)

#### 查看配置发布历史

1. 单击 **配置发布历史** 标签页。
2. 选择目标部署组 ，单击【查询】。
![](https://main.qcloudimg.com/raw/763052bfcd592b44af73dc618346415c.png)

#### 配置回滚

1. 单击 **配置发布历史** 标签页。
2. 单击配置发布历史列表右侧的【回滚】按钮。
![](https://main.qcloudimg.com/raw/b0691832d61c8dee00288950f9ae1a7b.png)
3. 填写回滚说明，单击【提交】。
![](https://main.qcloudimg.com/raw/ad8e82ef8572be18096d1ba9d3913334.png)


## 服务治理

服务是微服务平台管理的基本单元。服务管理包括服务的生命周期管理和服务治理两部分。

### 服务基本操作
服务基本操作包括创建服务和删除服务。

#### 创建服务

1. 登录 TSF 控制台。
2. 单击左侧导航栏的 **服务治理**，选择集群和命名空间。
3. 单击服务列表页的【新建】。
![](https://main.qcloudimg.com/raw/bef30b2ea43ebe54721c3ea4343bdddb.png)
4. 设置服务的基本信息后，单击【提交】按钮。 
 - **服务名称**：要创建的服务的名称，不超过 60 个字符。服务名称由小写字母、数字和 - 组成，且由小写字母开头，小写字母或数字结尾。  
 - **服务描述**：服务的描述信息。
![](https://main.qcloudimg.com/raw/21e7a9c148150081487302691d8d3c18.png)


#### 删除服务

1. 单击服务列表右侧【删除】。
![](https://main.qcloudimg.com/raw/a52d4104d22b5d723722c4909d556dcd.png)
2. 在弹框中单击【确认】按钮。
![](https://main.qcloudimg.com/raw/bbcc6bf057fe01f75b581bfc65ad23dc.png)

>**注意：**
>只有当服务运行的实例数为0时，可删除服务。


### 服务鉴权

服务可通过配置黑白名单来进行访问控制。一个服务只能具有白名单或者黑名单，两者是互斥关系。被调服务将处理来自白名单中服务的请求，拒绝处理来自黑名单服务中的请求。

#### 添加黑（白）名单

1. 登录 TSF 控制台。
2. 单击左侧导航栏 **服务治理**。
3. 单击服务列表中目标服务的 **ID/服务名**。
4. 在【基本信息】标签页中，单击【访问管理】。
![](https://main.qcloudimg.com/raw/29bb33019fa1a7afe6a65b79abe9ec3b.png)
5. 选择 **白名单** 或者 **黑名单**，从服务列表中选择服务加入到 **白名单** 或者 **黑名单** 中。
![](https://main.qcloudimg.com/raw/a23aa7ed23fdba4592f506011016b9a0.png)

#### 将服务从黑（白）名单中移除

1. 单击黑白名单列表的【移除】。
![](https://main.qcloudimg.com/raw/727f4ee7873f33ababa58c622bf6b926.png)
2. 在弹出的删除确认面板中，单击【确定】。
![](https://main.qcloudimg.com/raw/01e9606d142886593c77a7d5d8701a7b.png)

## 全局配置

TSF 的全局配置功能支持命名空间级别的分布式配置能力。

### 全局配置基本操作

#### 新建全局配置
1. 登录 TSF 控制台。
2. 单击导航栏 **全局配置**。
3. 单击【新建】按钮。
![](https://main.qcloudimg.com/raw/6630a67148d43beee12fe66cdae94a1d.png)
6. 填写配置内容。配置可以按照 YAML 或者键值对的方式进行编辑。
![](https://main.qcloudimg.com/raw/61108e5d3e4c748ce46d1e6f81232ef3.png)
7. 单击【提交】按钮。


#### 生成新版本全局配置
1. 单击配置列表右侧的【生成新版本】。 
![](https://main.qcloudimg.com/raw/7a767bfa5ff91001e0cfb2fc221891c7.png)
2. 填写变更的配置内容和版本号。
3. 单击【提交】按钮。
![](https://main.qcloudimg.com/raw/d94f9425093a0ccad30bfe1116a5ba2d.png)

>**注意**:
> 新版本配置的版本号不能与原版本相同。

#### 发布全局配置
1. 单击配置列表右侧的【发布】按钮。
![](https://main.qcloudimg.com/raw/95d977d63163c0e117b74b56bd54bb8d.png)
2. 选择配置发布的集群和命名空间，填写发布描述。
3. 单击【提交】。
![](https://main.qcloudimg.com/raw/f8f0b7bd9b1a6d4fc3b046194b321178.png)

#### 删除全局配置
1. 单击配置列表右侧的【删除】。
![](https://main.qcloudimg.com/raw/feea1823d010aba47e29cc457c5fb1d4.png)
2. 在弹框中，单击【确认】。
 

### 全局配置和应用配置的关系

当部署组和其所属的命名空间都有配置时，配置生效的优先级如下：

```
当配置的 key 相同时，部署组的配置高于命名空间的配置；其余情况下，两者的配置将合并。
```


## 日志服务

日志服务为用户提供一站式日志服务，从日志采集、日志存储到日志内容搜索，帮助用户轻松定位业务问题。


### 日志配置项

用户通过在控制台上创建日志配置项，然后将日志配置项与应用的部署组关联。TSF 通过日志配置项获取到日志的路径信息，从而实现日志的采集。

#### 创建日志配置

1. 登录 TSF 控制台。
2. 单击左侧导航栏 **日志配置**。
3. 单击【新建配置】，在弹出框中填写日志配置项信息。
	- 配置名称：日志配置名称，不超过60个字符。
	- 日志路径：可填写一个或者多个日志路径。
3. 单击【提交】按钮。

![](https://mc.qcloudimg.com/static/img/bf1f3d04bd057820a07de7f492849401/image.png)

#### 创建部署组时关联日志配置项
用户可以在创建应用时将日志配置项关联到应用。

1. 登录 TSF 控制台。
2. 单击左侧导航栏 **部署组**。
3. 单击【新建部署组】，在弹出框中填写应用信息和关联的日志配置。
4. 单击【提交】按钮。

![](https://main.qcloudimg.com/raw/e8172cfa422ff26eba6140929603aff5.png)

### 实时日志

当用户将应用日志打印到日志配置项中指定的路径下时，可以在应用的【日志】标签页中查看应用的实时日志数据。

1. 登录 TSF 控制台，点击左侧导航栏【应用管理】。
2. 选择某应用，进入应用详情页中，单击【日志】标签。
3. 选择查询的起始时间，点击【查询】按钮，查看应用日志数据。
![](https://mc.qcloudimg.com/static/img/f0e006d5b27b1eb3fde504bbfbf4d9ae/image.png)

### 日志搜索

采集的日志数据实时建索引，用户可以在控制台使用关键词进行检索。

1. 登录 TSF 控制台，点击左侧导航栏【日志搜索】。
2. 选择搜索的时间范围。
3. 选择搜索的范围，可以指定应用和实例。
4. 输入日志关键词，点击【查询】按钮。

![](https://mc.qcloudimg.com/static/img/3f93aa77d24a539a69c33b209995611d/image.png)

## 服务依赖拓扑与调用链

### 服务依赖拓扑

服务依赖拓扑包含了查询服务之间相互依赖调用的拓扑关系，查询特定集群特定命名空间下服务之间调用的统计结果等功能。

### 查询拓扑关系

1. 点击左侧【服务依赖拓扑】进入服务依赖拓扑界面。
2. 选择白色页面左上角数据中心位置，选择需要查看的服务的所属集群，以及所属命名空间。
3. 下方按钮选择需要依赖拓扑的时间，近30分钟、近10分钟、近5分钟以及选择特定时间段。需要注意的是特定时间段的时间跨度最长为32天。
4. 选择之后将在下方空白处出现对应的服务依赖调用关系。

灰色的圆圈表示主动调用的服务，箭头表示发出调用。绿色的圆圈表示成功调用，黄色表示调用失败。绿色和黄色组成的圆圈，绿色所占的比例是成功调用的比例，黄色为失败的比例。圆圈中的数字表示平均调用耗时和调用频率。

如下图所示：

![](https://main.qcloudimg.com/raw/721d8fc1ef1685efb17b228010d43385.png)

在选中时间范围内，provider-demo调用了consumer-demo服务，调用成功比例为99.99% （绿色部分）。其中平均每次调用耗时1.3ms，请求频率为每分钟6.8次。


### 查询依赖详情
鼠标放置到图上特定位置可以显示调用依赖详情。

- 放置在服务间的依赖线条上，弹出面板显示被调用者和调用次数统计，点击弹出框上的“查看调用链”可以进入到调用链查询界面。
![](https://main.qcloudimg.com/raw/b949f45a1b338b5e78d4f57e13a95171.png)
- 放置在服务圈内（白色底），可以展示被调用次数，也可以跳转进入调用链查询界面。
![](https://main.qcloudimg.com/raw/69f3f231854480bf09b26fe9f0300eff.png)
- 放置在被调用的服务圆圈外环，可以显示具体的调用成功次数（绿色）或者失败次数（黄色）。
![](https://main.qcloudimg.com/raw/caa4c921ad80673c877b7308625a09b5.png)

### 调用链查询

调用链查询用来查询和定位具体某一次调用的情况。使用者可以通过具体的服务、接口定位、IP等来查询具体的调用过程，查找调用过程所需要的时间和运行情况。

#### 操作步骤
1. 登录 TSF 控制台。
2. 在左侧导航栏中选择 **调用链查询** 。
3. 设置查询条件，单击【查询】按钮。
	- **时间范围**：支持特定和自定义时间范围选择。特定时间范围包括：1分钟前、10分钟前和30分钟前。
	- **调用服务/调用接口**：单击下拉框，在下拉框中选择服务，可以输入关键字进行搜索。
	- **被调服务/被调接口**：单击下拉框，在下拉框中选择服务，可以输入关键字进行搜索。
	- **耗时阈值**：设置耗时的阈值，可以查询系统中的慢业务。
	- 勾选【查询】按钮右侧的 【仅查询出错的调用链】，可以查询系统中的出错业务。
	- 其他高级查询参数根据需要进行设置。
4. 根据查询结果，可以单击 **traceID** 进入具体慢业务或出错业务，查看调用链详情。

![](https://main.qcloudimg.com/raw/e7fd1c77c424a30004f621ca98509b7b.png)

### 通过 TraceID 查看调用链

通过调用链详情，可以根据 TraceID 查询调用链的详细信息。调用链详情是为了定位在分布式链路调用过程中每个环节的耗时和异常（不包含本地方法调用情况，本地方法调用建议使用业务 log 的方式记录）。
通过调用链通常为了解决如下几个问题：

- 定位耗时较长的服务
- 不合理的调用逻辑（如一次请求多次调用某服务，建议改为批量调用接口）

#### 操作步骤
1. 登录 TSF 控制台。
2. 在左侧导航栏中选择 **调用链详情** 。
3. 在搜索框中输入目标 TraceID ，点击搜索按钮。
![](https://main.qcloudimg.com/raw/5fc73115308f9249db11e746912c4378.png)
4. 如果搜索有结果，显示调用链每个环节的耗时和状态。
![](https://main.qcloudimg.com/raw/b7de068eecbbe20fdd3099e5df78c5b8.png)
5. 将鼠标移动到每个环节的时间条上并点击，会弹出Span的详细信息。
![](https://main.qcloudimg.com/raw/4f63dbddaa1aa2f6f2d8309c2c4c518c.png)


## 事务管理

TSF 分布式事务服务（TSF Distributed Transaction Service, TDTS）是一款高性能、高可靠的分布式事务中间件，旨在解决分布式环境下的事务一致性问题。一个完整的业务往往涉及到多个子业务，随着业务数增加，系统逐渐演变为分布式系统，进而带来了数据一致性的问题。

### TCC 模式介绍
TCC 模式是应用层的两阶段提交：先 try, 再执行 confirm；若 try 失败，则执行cancel。

TCC 模式解决的问题包括但不限于：

- 数据库的两阶段并发性能差
- 数据库对XA协议的支持可能不完善
- 在分布式架构下，主业务系统并非直接操作数据库，而是调用从业务系统的服务接口

TCC 模式的事务执行流程：

1. 依次调用从业务系统的 Try 接口
2. 若 Try 阶段成功，则依次调用从业务系统的 Confirm 接口
3. 若在 Try 阶段出现失败，则调用从业务系统的 Cancel 接口，对 Try 接口的操作进行恢复
4. 若在 Confirm 阶段出现失败，则重试，设置重试次数。若重试仍然失败，则需要事后处理
5. 若调用 Cancel 接口失败，也进行重试操作


### 名词解释

**事务**：作为单个逻辑工作单元执行的一系列操作，要么全部执行，要么全部不执行。

**分布式事务**：事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

**主事务**：主调方提供服务的入口事务（使用 @TSFTransaction 注解）。

**子事务**：主调方操作数据库或者调用其他服务的事务（使用 @TSFTransaction 注解）。

**事务 ID**：TDTS 会为每一个分布式事务生产一个全局唯一的事务 ID。

### 控制台查询事务
 
1. 登录 TSF 控制台。
2. 在左侧导航栏中选择 **调用链详情** 。
3. 输入需要查看的事务流水的时间范围。
4. 输入希望查找的事务状态：
    - 尝试中：对应 TCC 中的 try 的进行时状态
    - 确认中：对应 TCC 中的 confirm 的进行时状态
    - 取消中：对应 TCC 中的 cancel 的进行时状态
    - 已确认：对应 TCC 中的 try 的完成时状态
    - 已取消：对应 TCC 中的 confirm 的完成时状态
    - 已超时：对应 TCC 中的 cancel 的进行时状态
    - 全部

![](https://main.qcloudimg.com/raw/664fd5383bdb3350c57b22cf30927d52.png)








