## 调用链查询
调用链查询用来查询和定位具体某一次调用的情况。使用者可以通过具体的服务、接口定位、IP等来查询具体的调用过程，查找调用过程所需要的时间和运行情况。

#### 操作步骤
1. 登录 TSF 控制台。
2. 在左侧导航栏中选择 **调用链查询** 。
3. 设置查询条件，单击【查询】按钮。
	- **时间范围**：支持特定和自定义时间范围选择。特定时间范围包括：1分钟前、10分钟前和30分钟前。
	- **调用服务/调用接口**：单击下拉框，在下拉框中选择服务，可以输入关键字进行搜索。
	- **被调服务/被调接口**：单击下拉框，在下拉框中选择服务，可以输入关键字进行搜索。
	- **耗时阈值**：设置耗时的阈值，可以查询系统中的慢业务。
	- 勾选【查询】按钮右侧的 【仅查询出错的调用链】，可以查询系统中的出错业务。
	- 其他高级查询参数根据需要进行设置。
4. 根据查询结果，可以单击 **traceID** 进入具体慢业务或出错业务，查看调用链详情。

![](https://main.qcloudimg.com/raw/e7fd1c77c424a30004f621ca98509b7b.png)

## 调用链详情

通过调用链详情，可以根据 TraceID 查询调用链的详细信息。调用链详情是为了定位在分布式链路调用过程中每个环节的耗时和异常（不包含本地方法调用情况，本地方法调用建议使用业务 log 的方式记录）。
通过调用链通常为了解决如下几个问题：

- 定位耗时较长的服务
- 不合理的调用逻辑（如一次请求多次调用某服务，建议改为批量调用接口）

#### 操作步骤
1. 登录 TSF 控制台。
2. 在左侧导航栏中选择 **调用链详情** 。
3. 在搜索框中输入目标 TraceID ，点击搜索按钮。
![](https://main.qcloudimg.com/raw/5fc73115308f9249db11e746912c4378.png)
4. 如果搜索有结果，显示调用链每个环节的耗时和状态。
![](https://main.qcloudimg.com/raw/b7de068eecbbe20fdd3099e5df78c5b8.png)
5. 将鼠标移动到每个环节的时间条上并点击，会弹出Span的详细信息。
![](https://main.qcloudimg.com/raw/4f63dbddaa1aa2f6f2d8309c2c4c518c.png)


## 分布式事务

TSF 分布式事务服务（TSF Distributed Transaction Service, TDTS）是一款高性能、高可靠的分布式事务中间件，旨在解决分布式环境下的事务一致性问题。一个完整的业务往往涉及到多个子业务，随着业务数增加，系统逐渐演变为分布式系统，进而带来了数据一致性的问题。

### 产品优势
TDTS 基于 TCC 模式，相比于其他分布式事务解决方案，具有如下优势：

| 优势 | TDTS | 基于 XA | 消息模式 | 开源 TCC|
|---------|---------|---------|---------|---------|
| 业界使用情况 | 基于 TCC，使用广泛 | 较少 | 常用，但没有TCC广泛 | 使用广泛|
| 对数据库要求 | 无 | 要求数据库支持XA协议 | 无 | 无|
| 并发性能 | 高 | 较差 | 高 | 高|
| 实现难度 | 简单 | 较难 | 开源 MQ 未提供，需二次开发 | 简单|
| 与微服务框架结合 | 支持 Spring Cloud, Dubbo 服务框架 | 不支持 | 不支持 | 需要改造|
| 事务回溯 | 支持查看历史事务，方便查错 | 不支持 | 不支持 | 需要改造|


### TCC 模式介绍
TCC 模式是应用层的两阶段提交：先 try, 再执行 confirm；若 try 失败，则执行cancel。

TCC 模式解决的问题包括但不限于：

- 数据库的两阶段并发性能差
- 数据库对XA协议的支持可能不完善
- 在分布式架构下，主业务系统并非直接操作数据库，而是调用从业务系统的服务接口

TCC 模式的事务执行流程：

1. 依次调用从业务系统的 Try 接口
2. 若 Try 阶段成功，则依次调用从业务系统的 Confirm 接口
3. 若在 Try 阶段出现失败，则调用从业务系统的 Cancel 接口，对 Try 接口的操作进行恢复
4. 若在 Confirm 阶段出现失败，则重试，设置重试次数。若重试仍然失败，则需要事后处理
5. 若调用 Cancel 接口失败，也进行重试操作


### 名词解释

**事务**：作为单个逻辑工作单元执行的一系列操作，要么全部执行，要么全部不执行。

**分布式事务**：事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

**主事务**：主调方提供服务的入口事务（使用 @TSFTransaction 注解）。

**子事务**：主调方操作数据库或者调用其他服务的事务（使用 @TSFTransaction 注解）。

**事务 ID**：TDTS 会为每一个分布式事务生产一个全局唯一的事务 ID。

###
 






